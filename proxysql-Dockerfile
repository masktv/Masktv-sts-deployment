# Use the official ProxySQL image as a base
FROM proxysql/proxysql:latest

# Expose ProxySQL admin and client ports
EXPOSE 6032 6033

# Arguments for ProxySQL configuration
ARG ADMIN_USER
ARG ADMIN_USER_PASSWORD
ARG MYSQL_USER
ARG MYSQL_PASSWORD
ARG MYSQL_MASTER_HOST
ARG MYSQL_SLAVE_HOST
ARG MYSQL_HOSTGROUP_MASTER
ARG MYSQL_HOSTGROUP_SLAVE

# Set environment variables from arguments
ENV ADMIN_USER=${ADMIN_USER}
ENV ADMIN_USER_PASSWORD=${ADMIN_USER_PASSWORD}
ENV MYSQL_USER=${MYSQL_USER}
ENV MYSQL_PASSWORD=${MYSQL_PASSWORD}
ENV MYSQL_MASTER_HOST=${MYSQL_MASTER_HOST}
ENV MYSQL_SLAVE_HOST=${MYSQL_SLAVE_HOST}
ENV MYSQL_HOSTGROUP_MASTER=${MYSQL_HOSTGROUP_MASTER}
ENV MYSQL_HOSTGROUP_SLAVE=${MYSQL_HOSTGROUP_SLAVE}

# Copy the initialization script to the appropriate location
COPY ./proxysql-init.sh /proxysql-init.sh

# Ensure the init script is executable
RUN chmod +x /proxysql-init.sh

# Use the default entrypoint for ProxySQL
ENTRYPOINT ["/proxysql-init.sh", "&&", "proxysql", "--config-file=/etc/proxysql.cnf"]

# Command to start ProxySQL server
CMD ["proxysql", "--config-file=/etc/proxysql.cnf"]
